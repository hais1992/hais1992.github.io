<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.8.0"><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="Hais1992"><title>使用Ubuntu16.04编译SudaMod · Hello_海生</title><meta name="description" content="注：文章参考 https://github.com/wzv5/android_device_zuk_z2_plus/wiki/ 进行修改整理。准备工作

电脑磁盘空余150G以上
电脑运存大于4G
推荐使用Ubuntu16.04
安装系统时 swap 推荐设置10G
推荐设置 /tmp 空间为10G"><meta name="keywords"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">Hello_海生</a></h3><div class="description"><p>一个屌丝程序员的个人记事本！</p></div></div></div><ul class="social-links"></ul><div class="footer"><a href="/"><span>Site by </span></a><a target="_blank" href="https://hexo.io/zh-cn"> Hexo </a><span>&</span><a target="_blank" href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="http://t.hais.pw" target="_blank">优惠券</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li><li><a href="/links">友链</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>使用Ubuntu16.04编译SudaMod</a></h3></div><div class="post-content"><h5 id="注：文章参考-https-github-com-wzv5-android-device-zuk-z2-plus-wiki-进行修改整理。"><a href="#注：文章参考-https-github-com-wzv5-android-device-zuk-z2-plus-wiki-进行修改整理。" class="headerlink" title="注：文章参考 https://github.com/wzv5/android_device_zuk_z2_plus/wiki/ 进行修改整理。"></a>注：文章参考 <a href="https://github.com/wzv5/android_device_zuk_z2_plus/wiki/" target="_blank" rel="noopener">https://github.com/wzv5/android_device_zuk_z2_plus/wiki/</a> 进行修改整理。</h5><h3 id="准备工作"><a href="#准备工作" class="headerlink" title="准备工作"></a>准备工作</h3><blockquote>
<ul>
<li>电脑磁盘空余150G以上</li>
<li>电脑运存大于4G</li>
<li>推荐使用Ubuntu16.04</li>
<li>安装系统时 swap 推荐设置10G</li>
<li>推荐设置 /tmp 空间为10G</li>
<li>系统默认使用 Python2</li>
</ul>
</blockquote>
<h3 id="1、分区调整-如安装系统时已设置swap比较大的可不设置"><a href="#1、分区调整-如安装系统时已设置swap比较大的可不设置" class="headerlink" title="1、分区调整(如安装系统时已设置swap比较大的可不设置)"></a>1、分区调整(如安装系统时已设置swap比较大的可不设置)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">sudo dd <span class="keyword">if</span>=/dev/zero of=/swapfile.img bs=1M count=10240</span><br><span class="line">sudo chmod 600 /swapfile.img</span><br><span class="line">sudo mkswap /swapfile.img</span><br><span class="line">sudo swapon /swapfile.img</span><br><span class="line"><span class="comment">#编辑 /etc/fstab 在最后加入一行</span></span><br><span class="line">/swapfile.img	swap	swap	defaults			0	0</span><br><span class="line">tmpfs			/tmp	tmpfs	defaults,size=10G	0	0</span><br><span class="line"><span class="comment">#调整完成后可使用 free -h 查看</span></span><br></pre></td></tr></table></figure>
<h3 id="2、安装编译工具"><a href="#2、安装编译工具" class="headerlink" title="2、安装编译工具"></a>2、安装编译工具</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get update &amp;&amp; sudo apt-get install git-core gnupg flex bison gperf libsdl1.2-dev libesd0-dev libwxgtk3.0-dev squashfs-tools build-essential zip curl libncurses5-dev zlib1g-dev openjdk-8-jre openjdk-8-jdk pngcrush schedtool libxml2 libxml2-utils xsltproc lzop libc6-dev schedtool g++-multilib lib32z1-dev lib32ncurses5-dev gcc-multilib maven tmux screen w3m ncftp liblz4-tool pngquant bc</span><br><span class="line"><span class="comment">#编译过程中缺少依赖rsync,使用sudo apt-get install rsync解决</span></span><br></pre></td></tr></table></figure>
<h3 id="3、由于同步Android源码需要翻墙，可以使用修改hosts的方法翻墙"><a href="#3、由于同步Android源码需要翻墙，可以使用修改hosts的方法翻墙" class="headerlink" title="3、由于同步Android源码需要翻墙，可以使用修改hosts的方法翻墙"></a>3、由于同步Android源码需要翻墙，可以使用修改hosts的方法翻墙</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo wget https://raw.githubusercontent.com/sy618/hosts/master/FQ -O /etc/hosts</span><br></pre></td></tr></table></figure>
<h3 id="4、安装repo"><a href="#4、安装repo" class="headerlink" title="4、安装repo"></a>4、安装repo</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载安装</span></span><br><span class="line">sudo wget https://storage.googleapis.com/git-repo-downloads/repo -O /usr/bin/repo</span><br><span class="line">sudo chmod +x /usr/bin/repo</span><br></pre></td></tr></table></figure>
<h3 id="5、创建源码目录并进入"><a href="#5、创建源码目录并进入" class="headerlink" title="5、创建源码目录并进入"></a>5、创建源码目录并进入</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p ~/Android/SudaMod &amp;&amp; <span class="built_in">cd</span> ~/Android/SudaMod</span><br></pre></td></tr></table></figure>
<h3 id="6、下载配置清单文件"><a href="#6、下载配置清单文件" class="headerlink" title="6、下载配置清单文件"></a>6、下载配置清单文件</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#下载核心官方的清单文件</span></span><br><span class="line">repo init -u git://github.com/SudaMod/android.git -b sm-3.1</span><br><span class="line"><span class="comment">#配置个人自定义的清单文件，包含device、vendor、kernel</span></span><br><span class="line">mkdir -p .repo/local_manifests &amp;&amp; <span class="built_in">cd</span> .repo/local_manifests</span><br><span class="line">wget https://raw.githubusercontent.com/wzv5/android_device_zuk_z2_plus/sm-3.1/z2_sm_manifest.xml</span><br></pre></td></tr></table></figure>
<h3 id="7、开始同步源码"><a href="#7、开始同步源码" class="headerlink" title="7、开始同步源码"></a>7、开始同步源码</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">cd</span> ~/Android/SudaMod</span><br><span class="line">repo sync -c -f -j$( nproc --all ) --force-sync --no-clone-bundle --no-tags</span><br></pre></td></tr></table></figure>
<h3 id="8、同步完成后，创建一个编译环境的脚本”sudamodBuild-sh”输入以下内容"><a href="#8、同步完成后，创建一个编译环境的脚本”sudamodBuild-sh”输入以下内容" class="headerlink" title="8、同步完成后，创建一个编译环境的脚本”sudamodBuild.sh”输入以下内容"></a>8、同步完成后，创建一个编译环境的脚本”sudamodBuild.sh”输入以下内容</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="meta">#!/bin/sh</span></span><br><span class="line"><span class="comment"># 改为自己的源码路径</span></span><br><span class="line">BASEPATH=~/Android/DirtyUnicorns</span><br><span class="line"><span class="comment"># 创建 ccache 缓存目录</span></span><br><span class="line">mkdir -p <span class="variable">$BASEPATH</span>/ccache_dir</span><br><span class="line"><span class="built_in">export</span> USE_CCACHE=1</span><br><span class="line"><span class="built_in">export</span> CCACHE_DIR=<span class="variable">$BASEPATH</span>/ccache_dir</span><br><span class="line"><span class="built_in">export</span> JACK_SERVER_VM_ARGUMENTS=<span class="string">"-Xmx4096M -Dfile.encoding=UTF-8 -XX:+TieredCompilation"</span></span><br><span class="line"><span class="built_in">export</span> SDCLANG=<span class="literal">true</span></span><br><span class="line"><span class="built_in">export</span> SDCLANG_PATH=<span class="variable">$BASEPATH</span>/prebuilts/snapdragon/llvm-3.8/bin</span><br><span class="line"><span class="built_in">export</span> SDCLANG_LTO_DEFS=<span class="variable">$BASEPATH</span>/device/qcom/common/sdllvm-lto-defs.mk</span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$BASEPATH</span></span><br><span class="line">make clean</span><br><span class="line">make clobber</span><br><span class="line">./prebuilts/sdk/tools/jack-admin <span class="built_in">kill</span>-server</span><br><span class="line">wget https://raw.githubusercontent.com/sy618/hosts/master/FQ -O ./system/core/rootdir/etc/hosts</span><br><span class="line">./prebuilts/misc/linux-x86/ccache/ccache -M 50G</span><br><span class="line"><span class="built_in">source</span> build/envsetup.sh</span><br><span class="line">breakfast z2_plus</span><br><span class="line">mka bacon -j$( nproc --all )</span><br></pre></td></tr></table></figure>
<p>保存并退出后，给脚本执行权限<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">chmod +x sudamodBuild.sh</span><br></pre></td></tr></table></figure></p>
<h3 id="9、开始编译"><a href="#9、开始编译" class="headerlink" title="9、开始编译"></a>9、开始编译</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#执行刚刚的脚本进入编译环境</span></span><br><span class="line"><span class="built_in">source</span> sudamodBuild.sh</span><br><span class="line"><span class="comment">#开始编译</span></span><br><span class="line">brunch z2_plus</span><br><span class="line"><span class="comment">#编译结算后执行命令释放资源</span></span><br><span class="line">croot</span><br><span class="line">./prebuilts/sdk/tools/jack-admin <span class="built_in">kill</span>-server</span><br><span class="line"><span class="comment">#执行清理，便于下次编译</span></span><br><span class="line">croot</span><br><span class="line">make clean</span><br></pre></td></tr></table></figure>
<h2 id="其它说明"><a href="#其它说明" class="headerlink" title="其它说明"></a>其它说明</h2><blockquote>
<ul>
<li>如果要收集编译日记，则编译的时候执行“brunch z2_plus | tee ~/sudalog.txt”</li>
<li>后期更新的话就 “repo sync” 同步上游源码，再次编译就可以了</li>
<li>制作OTA包   <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#每次编译完后进入目录，把 sm_z2_plus-target_files-xxx.zip 文件备份</span></span><br><span class="line">~/Android/SudaMod/out/target/product/z2_plus/obj/PACKAGING/target_files_intermediates</span><br><span class="line"><span class="comment">#当包有两个后，就可以使用命令制作增量包了</span></span><br><span class="line">croot</span><br><span class="line">./build/tools/releasetools/ota_from_target_files -i sm_z2_plus-target_files-old.zip sm_z2_plus-target_files-new.zip ota.zip</span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li><p>添加主题引擎，编辑清单文件 ~/Android/SudaMod/.repo/local_manifests 增加以下两行内容，后执行 “repo sync” 同步</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;project name=<span class="string">"sudamod/android_vendor_extra-1"</span> path=<span class="string">"vendor/extra"</span> remote=<span class="string">"github"</span> revision=<span class="string">"cm-14.1-rootless"</span>/&gt;</span><br><span class="line">&lt;project name=<span class="string">"substratum/interfacer"</span> path=<span class="string">"packages/services/ThemeInterfacer"</span> remote=<span class="string">"github"</span> revision=<span class="string">"n-rootless"</span>/&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#每次同步源码都需要重新打补丁 " ./vendor/extra/patch.sh "</span></span><br><span class="line"><span class="comment">#加入主题管理器，创建 prebuilt 目录，在其中放入主题管理器 Substratum.apk 文件，编辑 sm.mk 文件，在最后加入以下代码后保存即可</span></span><br><span class="line">PRODUCT_COPY_FILES += \$(LOCAL_PATH)/prebuilt/Substratum.apk:/system/app/Substratum/Substratum.apk</span><br></pre></td></tr></table></figure>
</li>
<li><p>编译的时候偶尔卡住不动或者有提示“Compiling SDK Stubs with Jack”，的可以改一下jack的配置文件</p>
  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#修改 ./prebuilts/sdk/tools/jack-admin，找到</span></span><br><span class="line">JACK_SERVER_COMMAND=<span class="string">"java -XX:MaxJavaStackTraceDepth=-1 -Djava.io.tmpdir=<span class="variable">$TMPDIR</span> <span class="variable">$JACK_SERVER_VM_ARGUMENTS</span> -cp <span class="variable">$LAUNCHER_JAR</span> <span class="variable">$LAUNCHER_NAME</span>"</span></span><br><span class="line"><span class="comment">#改为</span></span><br><span class="line">JACK_SERVER_COMMAND=<span class="string">"java -XX:MaxJavaStackTraceDepth=-1 -Djava.io.tmpdir=<span class="variable">$TMPDIR</span> <span class="variable">$JACK_SERVER_VM_ARGUMENTS</span> -Xmx4096M -cp <span class="variable">$LAUNCHER_JAR</span> <span class="variable">$LAUNCHER_NAME</span>"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
<ul>
<li>如果是使用远程机器进行编译，为了预防网络不稳定重连ssh的情况，可以使用 screen 来进行编译  <figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">sudo apt-get install screen</span><br><span class="line"><span class="comment">#新建一个名为 hais 的 screen</span></span><br><span class="line">screen -S hais</span><br><span class="line"><span class="comment">#显示一个名为 hais 的 screen</span></span><br><span class="line">screen -r -d hais</span><br><span class="line"><span class="comment">#显示所有正在运行的 screen</span></span><br><span class="line">screen -ls</span><br></pre></td></tr></table></figure></li>
</ul>
</blockquote>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-07-28</span><i class="fa fa-tag"></i><a href="/tags/Linux/" title="Linux" class="tag">Linux </a><a href="/tags/编译/" title="编译" class="tag">编译 </a><a href="/tags/Android/" title="Android" class="tag">Android </a><a href="/tags/Ubuntu/" title="Ubuntu" class="tag">Ubuntu </a><a href="/tags/SudaMod/" title="SudaMod" class="tag">SudaMod </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://hais.pw/2017/07/28/UbuntuBuildSudaMod/,Hello_海生,使用Ubuntu16.04编译SudaMod,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2017/09/15/MachineHexoPostArticle/" title="新电脑发布文章的方法" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2017/07/28/HexoPostArticle/" title="Hexo发布一篇新文章" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>